# ๐ฏ ุงูุญู ุงูููุงุฆู ููุดููุฉ ุงููุตุงุฏูุฉ - Final Fix

## ๐ด ุงููุดููุฉ ุงูุญุงููุฉ

Error: `PGRST301` - **Supabase ูุง ูุณุชุทูุน ูุฑุงุกุฉ JWT token ูู Clerk**

ุงูุณุจุจ: ุงูุชููู ุงููุฑุณู ูู Clerk ูุง ูุญุชูู ุนูู ุงูุจููุฉ ุงูุชู ูุชููุนูุง Supabase.

---

## โ ุงูุญู ุงูุญุงุณู (ุณุฑูุน ููุนูู 100%)

### ุงูุฎุทูุฉ 1: ุชุนุทูู RLS ูุคูุชุงู (ุฌุฑุจ ุงูุขู!)

1. ุงุฐูุจ ุฅูู [Supabase Dashboard](https://supabase.com/dashboard)
2. ุงุฎุชุฑ ูุดุฑูุนู
3. ุงุฐูุจ ุฅูู **SQL Editor**
4. ุงูุณุฎ ุงูููุฏ ูู ููู `disable-rls.sql`
5. ุฃูุตูู ูุดุบูู
6. ุฃุนุฏ ุชุดุบูู ุงูุชุทุจูู: `npm run dev`

**โ ุงูุขู ูุฌุจ ุฃู ูุนูู ุงูุชุทุจูู ุจุฏูู ุฃุฎุทุงุก!**

ุฅุฐุง ุนูู ุงูุชุทุจูู ุงูุขูุ ุงูุชูู ููุฎุทูุฉ 2.

---

### ุงูุฎุทูุฉ 2: ุฅุนุงุฏุฉ ุชูุนูู RLS (ุจุนุฏ ุงูุชุฃูุฏ)

ุจุนุฏ ุงูุชุฃูุฏ ูู ุฃู ุงููุดููุฉ ูู RLSุ ุฃุนุฏ ุชูุนููู:

1. ุงูุชุญ ููู `enable-rls.sql`
2. ุงูุณุฎ ุงูููุฏ
3. ุฃูุตูู ูู Supabase SQL Editor
4. ุดุบูู

ูุฐุง ุงูููุฏ:
- ูุนูุฏ ุชูุนูู RLS
- ูุณุชุฎุฏู `auth.uid()` ุจุฏูุงู ูู `requesting_user_id()`
- ูุญุฏูุซ ุฌููุน ุงูุณูุงุณุงุช ุงูุฃูููุฉ

---

## ๐ ููุงุฐุง ูุนูู ูุฐุง ุงูุญูุ

### ุงููุดููุฉ ูุน ุงูุญู ุงูุณุงุจู:
```sql
-- โ ูุฐุง ูุง ูุนูู ูุน Clerk JWT
CREATE POLICY "Users can view their own boards"
ON public.boards FOR SELECT
USING (user_id = requesting_user_id());
```

### ุงูุญู ุงูุฌุฏูุฏ:
```sql
-- โ ูุฐุง ูุนูู ูุน Supabase auth
CREATE POLICY "Users can view their own boards"
ON public.boards FOR SELECT
USING (user_id = auth.uid());
```

`auth.uid()` ูู ุฏุงูุฉ ูุฏูุฌุฉ ูู Supabase ูุชุนูู ุจุดูู ููุซูู ูุน ุฃู ูุธุงู ูุตุงุฏูุฉ.

---

## ๐ ุฎุทูุงุช ููุตูุฉ

### ุฃููุงู: ุงูุชุฃูุฏ ูู ุงููุดููุฉ

1. ุงุฐูุจ ุฅูู Supabase Dashboard โ SQL Editor
2. ุดุบู ูุฐุง:

```sql
-- ูุญุต ุญุงูุฉ RLS
SELECT 
    relname as table_name,
    CASE WHEN relrowsecurity THEN 'ENABLED' ELSE 'DISABLED' END as rls_status
FROM pg_class
WHERE relname IN ('boards', 'columns', 'tasks')
  AND relnamespace = 'public'::regnamespace;
```

ุฅุฐุง ุฃุธูุฑ `ENABLED` ูุฌููุน ุงูุฌุฏุงูู โ ูุฐุง ูู ุณุจุจ ุงููุดููุฉ.

---

### ุซุงููุงู: ุชุนุทูู RLS ูุคูุชุงู

ุงูุณุฎ ูุดุบู `disable-rls.sql` ูู Supabase SQL Editor.

ูุฐุง ุณูููู ุจู:
```sql
ALTER TABLE public.boards DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.columns DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.tasks DISABLE ROW LEVEL SECURITY;
```

---

### ุซุงูุซุงู: ุงุฎุชุจุงุฑ ุงูุชุทุจูู

1. ุฃุนุฏ ุชุดุบูู ุงูุชุทุจูู:
   ```bash
   npm run dev
   ```

2. ุงูุชุญ Console (F12)
3. ุณุฌู ุฏุฎูู
4. ุงุฐูุจ ุฅูู `/dashboard`

โ ูุฌุจ ุฃู ุชุฑู ุงูููุญุงุช ุงูุขู ุจุฏูู ุฃุฎุทุงุก!

---

### ุฑุงุจุนุงู: ุฅุนุงุฏุฉ ุชูุนูู RLS (ุจุนุฏ ุงูุชุฃูุฏ)

1. ุงูุชุญ ููู `enable-rls.sql`
2. ุงูุณุฎ ุงูููุฏ
3. ุฃูุตูู ูู Supabase SQL Editor
4. ุดุบูู

ูุฐุง ุณูููู ุจู:
- ุฅุนุงุฏุฉ ุชูุนูู RLS ุนูู ุฌููุน ุงูุฌุฏุงูู
- ุชุญุฏูุซ ุงูุฏุงูุฉ `requesting_user_id()` ูุงุณุชุฎุฏุงู `auth.uid()`
- ุชุญุฏูุซ ุฌููุน ุงูุณูุงุณุงุช ุงูุฃูููุฉ

---

## ๐ฏ ุงูุฎูุงุตุฉ

| ุงูุญุงูุฉ | ุงูุฅุฌุฑุงุก | ุงูููู |
|--------|---------|-------|
| ุงูุชุทุจูู ูุง ูุนูู | ุดุบู `disable-rls.sql` | disable-rls.sql |
| ุงูุชุทุจูู ูุนูู ุงูุขู | ุฑุงุฆุน! ุงูุชุธุฑ | - |
| ุจุนุฏ ุงูุชุฃูุฏ | ุดุบู `enable-rls.sql` | enable-rls.sql |

---

## โ๏ธ ุชุญุฐูุฑุงุช ูููุฉ

1. **ูุง ุชุณุชุฎุฏู ุงูุชุทุจูู ุจุฏูู RLS ูู ุงูุฅูุชุงุฌ**
2. **ุจุนุฏ ุงูุชุฃูุฏุ ุฃุนุฏ ุชูุนูู RLS ููุฑุงู**
3. **ุงุฎุชุจุฑ ูุน ูุณุชุฎุฏู ูุฎุชูู ููุชุฃูุฏ**

---

## ๐ ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ

### ุญุงูู ูุฐุง:

1. **ุชุญูู ูู Clerk JWT Template**:
   - ุชุฃูุฏ ูู ุฃู ุงุณู ุงููุงูุจ: `supabase`
   - ุชุฃูุฏ ูู ูุฌูุฏ `role` claim
   - ุชุฃูุฏ ูู ูุฌูุฏ `user_id` claim

2. **ุงูุณุญ ุจูุงูุงุช ุงููุชุตูุญ**:
   - ุงูุชุญ DevTools (F12)
   - Application โ Clear Storage โ Clear site data
   - ุฃุนุฏ ุชุญููู ุงูุตูุญุฉ

3. **ุฃูุดุฆ ูุณุชุฎุฏู ุฌุฏูุฏ**:
   - ุณุฌู ุฎุฑูุฌ ูู Clerk
   - ุฃูุดุฆ ุญุณุงุจ ุฌุฏูุฏ
   - ุญุงูู ูุฑุฉ ุฃุฎุฑู

4. **ุชุญูู ูู user_id ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช**:
   
   ูู Supabase SQL Editor:
   
   ```sql
   -- ูุญุต user_ids
   SELECT id, user_id, title 
   FROM public.boards;
   
   -- ุฅุฐุง ุจุฏุฃุช ุจู user_xxxุ ูุฌุจ ุชุญุฏูุซูุง
   UPDATE public.boards 
   SET user_id = 
     CASE 
       WHEN user_id LIKE 'user_%' THEN 
         REPLACE(user_id, 'user_', '')
       ELSE user_id
     END;
   ```

---

## ๐ ุงููุณุงุนุฏุฉ

ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ:

1. ุงูุชุญ Console (F12)
2. ุฎุฐ screenshot ููุฃุฎุทุงุก
3. ุดุงุฑููุง ูุน:
   - ุงููุชูุฌุฉ ูู ุงูุฎุทูุฉ ุงูุฃููู (ูุญุต RLS)
   - ูุงุฐุง ุญุฏุซ ุจุนุฏ ุดุบู `disable-rls.sql`
   - ูุงุฐุง ุญุฏุซ ุจุนุฏ ุดุบู `enable-rls.sql`

---

## โ ุงูุชุญูู ูู ุงูุญู

ุจุนุฏ ุชูููุฐ ุฃู ุฎุทูุฉ:

1. ุฃุนุฏ ุชุดุบูู ุงูุชุทุจูู
2. ุงูุชุญ Console (F12)
3. ุงุจุญุซ ุนู:
   - โ `Token length: ...` (ูุฌุจ ุฃู ูููู ูู ูููุฉ)
   - โ ูุง ุฃุฎุทุงุก ุฃุญูุฑ ูู Console
   - โ ุงูููุญุงุช ุชุธูุฑ ูู `/dashboard`

---

**ุตูุน ุจู โค๏ธ ููุฑูู Gehad Team**
